<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор миномета с картой Удачное</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            background: #f0f0f0;
        }
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        #menu {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        .menu-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }
        .menu-btn:hover {
            background-color: #555;
        }
        #controls {
            position: fixed;
            top: 20px;
            left: -300px;
            width: 250px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: left 0.3s ease;
            z-index: 1000;
        }
        #controls.active {
            left: 20px;
        }
        #controls label, #controls select, #controls input, #controls button {
            display: block;
            margin: 10px 0;
            padding: 6px;
            width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            border-radius: 4px;
        }
        #controls select, #controls input {
            border: 1px solid #ccc;
        }
        #controls button {
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #controls button:hover {
            background-color: #555;
        }
        #result {
            margin-top: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        #layer-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #device-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #device-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }
        #device-btn:hover {
            background-color: #555;
        }
        #device-options {
            display: none;
            position: absolute;
            bottom: 50px;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 10px;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }
        #device-options.active {
            display: flex;
        }
        #device-options button {
            padding: 8px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #device-options button:hover {
            background-color: #555;
        }
        #mobile-buttons {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        #mobile-buttons.active {
            display: flex;
        }
        .mobile-btn {
            padding: 8px 15px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .mobile-btn:hover {
            background-color: #555;
        }
        #mobile-close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }
        #mobile-close-btn:hover {
            color: #555;
        }
        @media (max-width: 600px) {
            #controls {
                width: 200px;
                left: -100vw;
            }
            #controls.active {
                left: 10px;
            }
            #layer-control {
                right: 10px;
            }
            #menu {
                top: 10px;
                left: 10px;
            }
            #device-selector {
                bottom: 10px;
                right: 10px;
            }
            #mobile-buttons {
                bottom: 60px;
                right: 10px;
            }
        }
        /* Info Panel Styles */
        #info-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
        }
        #info-panel.active {
            display: block;
        }
        #info-panel h2 {
            margin-top: 0;
        }
        #info-panel ul {
            padding-left: 20px;
        }
        #info-panel button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        #info-panel button:hover {
            background-color: #555;
        }
        #credits {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
            z-index: 1000;
            text-align: center;
        }
        #language-control {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .close-btn:hover {
            color: #555;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="menu">
        <button class="menu-btn" onclick="toggleControls()" title="Открыть настройки">&#9881;</button>
        <button class="menu-btn" onclick="clearMap()" title="Очистить карту"><i class="fas fa-trash"></i></button>
        <button class="menu-btn" onclick="toggleInfo()" title="Информация"><i class="fas fa-info-circle"></i></button>
    </div>
    <div id="controls">
        <button class="close-btn" onclick="toggleControls()">&times;</button>
        <label for="mortar" id="mortar-label">Тип оружия:</label>
        <select id="mortar">
            <option value="ua">UA (US M821 HE 81mm)</option>
            <option value="ru">RU (О-832Д 82mm)</option>
            <option value="grad">BM-21 Grad (122mm)</option>
        </select>
        <label for="distance" id="distance-label">Ручное расстояние (м, опционально):</label>
        <input type="number" id="distance" min="0" placeholder="например, 1350">
        <button id="calculate-manual-btn" onclick="calculateManual()">Рассчитать вручную</button>
        <div id="result"></div>
    </div>
    <div id="layer-control">
        <label for="layer" id="layer-label">Выбор карты:</label>
        <select id="layer" onchange="changeLayer()">
            <option value="udache">Удачное</option>
            <option value="osm">Сергеевка</option>
            <option value="satellite">Донецкий Аэропорт</option>
        </select>
    </div>
    <div id="language-control">
        <label for="language" id="language-label">Язык:</label>
        <select id="language" onchange="changeLanguage()">
            <option value="ru">рурский</option>
            <option value="uk">Українська</option>
            <option value="en">English</option>
        </select>
    </div>
    <div id="device-selector">
        <button id="device-btn" onclick="toggleDeviceOptions()" title="Выбор устройства">&#128241;</button>
        <div id="device-options">
            <button class="close-btn" onclick="toggleDeviceOptions()">&times;</button>
            <button id="pc-btn" onclick="setDevice('pc')">ПК</button>
            <button id="mobile-btn" onclick="setDevice('mobile')">Телефон</button>
        </div>
    </div>
    <div id="mobile-buttons">
        <button class="close-btn" id="mobile-close-btn" onclick="toggleMobileButtons()">&times;</button>
        <button class="mobile-btn" id="mortar-btn" onclick="activateMode('mortar')">Поставить миномёт</button>
        <button class="mobile-btn" id="target-btn" onclick="activateMode('target')">Поставить цель</button>
    </div>
    <div id="info-panel">
        <button class="close-btn" onclick="toggleInfo()">&times;</button>
        <h2 id="info-title">Информация</h2>
        <div id="info-text">
            <h3>Как использовать:</h3>
            <ul>
                <li>Выберите тип оружия в настройках.</li>
                <li>На ПК: Правый клик - поставить миномет (красный маркер), левый клик - поставить цель (синий маркер).</li>
                <li>На мобильном: Выберите режим (миномет или цель) и кликните на карту.</li>
                <li>Перетаскивайте маркеры для корректировки.</li>
                <li>Используйте ручной ввод расстояния для расчета без карты.</li>
                <li>Смените карту в выборе слоя.</li>
            </ul>
            <p>Расчеты основаны на таблицах для указанных боеприпасов.</p>
            <p><strong>Автор:</strong> PRONEDROG</p>
            <p><strong>Данные карт предоставлены:</strong> Conflict In Europe</p>
        </div>
    </div>
    <div id="credits">
        Powered by PRONEDROG | За поддержкой Conflict In Europe
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Language data
        const translations = {
            ru: {
                title: 'Калькулятор миномета с картой Удачное',
                mortarLabel: 'Тип оружия:',
                mortarOptions: {
                    ua: 'UA (US M821 HE 81mm)',
                    ru: 'RU (О-832Д 82mm)',
                    grad: 'BM-21 Grad (122mm)'
                },
                distanceLabel: 'Ручное расстояние (м, опционально):',
                calculateManualBtn: 'Рассчитать вручную',
                layerLabel: 'Выбор карты:',
                layerOptions: {
                    udache: 'Удачное',
                    osm: 'Сергеевка',
                    satellite: 'Донецкий Аэропорт'
                },
                languageLabel: 'Язык:',
                languageOptions: {
                    ru: 'Русский',
                    uk: 'Українська',
                    en: 'English'
                },
                deviceBtnTitle: 'Выбор устройства',
                pcBtn: 'ПК',
                mobileBtn: 'Телефон',
                mortarBtn: 'Поставить миномёт',
                targetBtn: 'Поставить цель',
                mortarPopup: 'Миномет',
                targetPopup: 'Цель',
                infoTitle: 'Информация',
                infoText: `
                    <h3>Как использовать:</h3>
                    <ul>
                        <li>Выберите тип оружия в настройках.</li>
                        <li>На ПК: Правый клик - поставить миномет (красный маркер), левый клик - поставить цель (синий маркер).</li>
                        <li>На мобильном: Выберите режим (миномет или цель) и кликните на карту.</li>
                        <li>Перетаскивайте маркеры для корректировки.</li>
                        <li>Используйте ручной ввод расстояния для расчета без карты.</li>
                        <li>Смените карту в выборе слоя.</li>
                    </ul>
                    <p>Расчеты основаны на таблицах для указанных боеприпасов.</p>
                    <p><strong>Автор:</strong> PRONEDROG</p>
                    <p><strong>Данные карт предоставлены:</strong> Conflict In Europe</p>
                `,
                closeBtn: 'Закрыть',
                clearMapTitle: 'Очистить карту',
                settingsTitle: 'Открыть настройки',
                infoBtnTitle: 'Информация',
                rangeText: 'Расстояние: ',
                azimuthText: 'Азимут: ',
                elevationText: 'Угол возвышения: ',
                outOfRange: 'Вне диапазона!',
                manualRange: 'Ручное расстояние: ',
                credits: 'Powered by PRONEDROG | За поддержкой Conflict In Europe'
            },
            uk: {
                title: 'Калькулятор міномета з картою Удачне',
                mortarLabel: 'Тип зброї:',
                mortarOptions: {
                    ua: 'UA (US M821 HE 81mm)',
                    ru: 'RU (О-832Д 82mm)',
                    grad: 'BM-21 Grad (122mm)'
                },
                distanceLabel: 'Ручна відстань (м, опціонально):',
                calculateManualBtn: 'Розрахувати вручну',
                layerLabel: 'Вибір карти:',
                layerOptions: {
                    udache: 'Удачне',
                    osm: 'Сергеївка',
                    satellite: 'Донецький Аеропорт'
                },
                languageLabel: 'Мова:',
                languageOptions: {
                    ru: 'російська',
                    uk: 'Українська',
                    en: 'English'
                },
                deviceBtnTitle: 'Вибір пристрою',
                pcBtn: 'ПК',
                mobileBtn: 'Телефон',
                mortarBtn: 'Поставити міномет',
                targetBtn: 'Поставити ціль',
                mortarPopup: 'Міномет',
                targetPopup: 'Ціль',
                infoTitle: 'Інформація',
                infoText: `
                    <h3>Як використовувати:</h3>
                    <ul>
                        <li>Виберіть тип зброї в налаштуваннях.</li>
                        <li>На ПК: Правий клік - поставити міномет (червоний маркер), лівий клік - поставити ціль (синій маркер).</li>
                        <li>На мобільному: Виберіть режим (міномет або ціль) і клікніть на карту.</li>
                        <li>Перетягуйте маркери для коригування.</li>
                        <li>Використовуйте ручний ввід відстані для розрахунку без карти.</li>
                        <li>Змініть карту у виборі шару.</li>
                    </ul>
                    <p>Розрахунки базуються на таблицях для вказаних боєприпасів.</p>
                    <p><strong>Автор:</strong> PRONEDROG</p>
                    <p><strong>Дані карт надано:</strong> Conflict In Europe</p>
                `,
                closeBtn: 'Закрити',
                clearMapTitle: 'Очистити карту',
                settingsTitle: 'Відкрити налаштування',
                infoBtnTitle: 'Інформація',
                rangeText: 'Відстань: ',
                azimuthText: 'Азимут: ',
                elevationText: 'Кут піднесення: ',
                outOfRange: 'Поза діапазоном!',
                manualRange: 'Ручна відстань: ',
                credits: 'Powered by PRONEDROG | За підтримки Conflict In Europe'
            },
            en: {
                title: 'Mortar Calculator with Udachne Map',
                mortarLabel: 'Weapon Type:',
                mortarOptions: {
                    ua: 'UA (US M821 HE 81mm)',
                    ru: 'RU (О-832Д 82mm)',
                    grad: 'BM-21 Grad (122mm)'
                },
                distanceLabel: 'Manual Distance (m, optional):',
                calculateManualBtn: 'Calculate Manually',
                layerLabel: 'Map Selection:',
                layerOptions: {
                    udache: 'Udachne',
                    osm: 'Sergeevka',
                    satellite: 'Donetsk Airport'
                },
                languageLabel: 'Language:',
                languageOptions: {
                    ru: 'russian',
                    uk: 'Ukrainian',
                    en: 'English'
                },
                deviceBtnTitle: 'Device Selection',
                pcBtn: 'PC',
                mobileBtn: 'Mobile',
                mortarBtn: 'Place Mortar',
                targetBtn: 'Place Target',
                mortarPopup: 'Mortar',
                targetPopup: 'Target',
                infoTitle: 'Information',
                infoText: `
                    <h3>How to Use:</h3>
                    <ul>
                        <li>Select weapon type in settings.</li>
                        <li>On PC: Right-click to place mortar (red marker), left-click to place target (blue marker).</li>
                        <li>On mobile: Select mode (mortar or target) and click on map.</li>
                        <li>Drag markers to adjust.</li>
                        <li>Use manual distance input for calculation without map.</li>
                        <li>Change map in layer selection.</li>
                    </ul>
                    <p>Calculations based on tables for specified ammunition.</p>
                    <p><strong>Author:</strong> PRONEDROG</p>
                    <p><strong>Map Data Provided by:</strong> Conflict In Europe</p>
                `,
                closeBtn: 'Close',
                clearMapTitle: 'Clear Map',
                settingsTitle: 'Open Settings',
                infoBtnTitle: 'Information',
                rangeText: 'Distance: ',
                azimuthText: 'Azimuth: ',
                elevationText: 'Elevation Angle: ',
                outOfRange: 'Out of Range!',
                manualRange: 'Manual Distance: ',
                credits: 'Powered by PRONEDROG | Supported by Conflict In Europe'
            }
        };

        let currentLang = 'ru';

        function changeLanguage() {
            currentLang = document.getElementById('language').value;
            updateTexts();
            document.title = translations[currentLang].title;
            updateLayerOptions();
            updateMortarOptions();
            updateInfoPanel();
            document.getElementById('distance').placeholder = currentLang === 'ru' ? 'например, 1350' : (currentLang === 'uk' ? 'наприклад, 1350' : 'e.g., 1350');
        }

        function updateTexts() {
            const t = translations[currentLang];
            document.getElementById('mortar-label').textContent = t.mortarLabel;
            document.getElementById('distance-label').textContent = t.distanceLabel;
            document.getElementById('calculate-manual-btn').textContent = t.calculateManualBtn;
            document.getElementById('layer-label').textContent = t.layerLabel;
            document.getElementById('language-label').textContent = t.languageLabel;
            document.getElementById('pc-btn').textContent = t.pcBtn;
            document.getElementById('mobile-btn').textContent = t.mobileBtn;
            document.getElementById('mortar-btn').textContent = t.mortarBtn;
            document.getElementById('target-btn').textContent = t.targetBtn;
            document.getElementById('device-btn').title = t.deviceBtnTitle;
            document.querySelector('.menu-btn:nth-child(2)').title = t.clearMapTitle;
            document.querySelector('.menu-btn:nth-child(1)').title = t.settingsTitle;
            document.querySelector('.menu-btn:nth-child(3)').title = t.infoBtnTitle;
            document.getElementById('credits').textContent = t.credits;
            if (mortarMarker) mortarMarker.bindPopup(t.mortarPopup);
            if (targetMarker) targetMarker.bindPopup(t.targetPopup);
        }

        function updateLayerOptions() {
            const t = translations[currentLang];
            const select = document.getElementById('layer');
            select.options[0].text = t.layerOptions.udache;
            select.options[1].text = t.layerOptions.osm;
            select.options[2].text = t.layerOptions.satellite;
        }

        function updateMortarOptions() {
            const t = translations[currentLang];
            const select = document.getElementById('mortar');
            select.options[0].text = t.mortarOptions.ua;
            select.options[1].text = t.mortarOptions.ru;
            select.options[2].text = t.mortarOptions.grad;
        }

        function updateInfoPanel() {
            const t = translations[currentLang];
            document.getElementById('info-title').textContent = t.infoTitle;
            document.getElementById('info-text').innerHTML = t.infoText;
            document.querySelector('#info-panel .close-btn').textContent = t.closeBtn;
        }

        function updateLanguageOptions() {
            const t = translations[currentLang];
            const select = document.getElementById('language');
            select.options[0].text = t.languageOptions.ru;
            select.options[1].text = t.languageOptions.uk;
            select.options[2].text = t.languageOptions.en;
        }

        // Инициализация карты с простой системой координат
        const mapWidth = 10240; // метры
        const mapHeight = 5120; // метры
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 2,
            zoom: -1,
            center: [mapHeight / 2, mapWidth / 2],
            maxBounds: [[0, 0], [mapHeight, mapWidth]],
            maxBoundsViscosity: 1.0
        });
       
// Наложение карты Удачное
        const udacheBounds = [[0, 0], [mapHeight, mapWidth]];
        const udacheLayer = L.imageOverlay('IMG_20250917_162744_657.png', osmBounds).addTo(map);
        
        // Другие слои
        const osmBounds = [[0, 0], [mapHeight, mapWidth]];
        const osmLayer = L.imageOverlay('IMG_20250917_162944_112[1].png', osmBounds).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
            noWrap: true
        });

        let currentLayer = udacheLayer;

        function changeLayer() {
            const layer = document.getElementById('layer').value;
            map.removeLayer(currentLayer);
            if (layer === 'udache') {
                currentLayer = udacheLayer;
                map.setView([mapHeight / 2, mapWidth / 2], -1);
                map.options.crs = L.CRS.Simple;
                map.setMaxBounds(udacheBounds);
            } else {
                map.options.crs = L.CRS.EPSG3857;
                map.setMaxBounds(null);
                map.setView([50.45, 30.52], 12);
                currentLayer = layer === 'satellite' ? satelliteLayer : osmLayer;
            }
            map.addLayer(currentLayer);
            if (mortarMarker) {
                map.removeLayer(mortarMarker);
                mortarMarker = null;
            }
            if (targetMarker) {
                map.removeLayer(targetMarker);
                targetMarker = null;
            }
            document.getElementById('result').innerHTML = '';
        }

        // Маркеры
        let mortarMarker = null;
        let targetMarker = null;

        // Данные минометов
        const uaMortarData = [
            [400, 1531], [500, 1514], [600, 1496], [700, 1478], [800, 1460], [900, 1442],
            [1000, 1424], [1100, 1405], [1200, 1385], [1300, 1366], [1400, 1346], [1500, 1326],
            [1600, 1305], [1700, 1283], [1800, 1261], [1900, 1238], [2000, 1214], [2100, 1188],
            [2200, 1162], [2300, 1134], [2400, 1104], [2500, 1070], [2600, 1034], [2700, 993],
            [2800, 942], [2900, 870]
        ];

        const ruMortarData = [
            [400, 1418], [500, 1398], [600, 1376], [700, 1355], [800, 1333], [900, 1311],
            [1000, 1288], [1100, 1264], [1200, 1240], [1300, 1215], [1400, 1189], [1500, 1161],
            [1600, 1133], [1700, 1102], [1800, 1069], [1900, 1034], [2000, 995], [2100, 950],
            [2200, 896], [2300, 820]
        ];

        const gradMortarData = [
            [3000, 140], [3200, 150], [3400, 159], [3600, 169], [3800, 179], [4000, 190],
            [4200, 200], [4400, 211], [4600, 221], [4800, 233], [5000, 244], [5200, 256],
            [5400, 268], [5600, 280], [5800, 293], [6000, 306], [6200, 320], [6400, 334],
            [6600, 349], [6800, 364], [7000, 380], [7200, 398], [7400, 416], [7600, 436],
            [7800, 458], [8000, 482], [8200, 509], [8400, 543], [8600, 587]
        ];

        function interpolate(data, dist) {
            if (dist < data[0][0] || dist > data[data.length - 1][0]) return null;
            for (let i = 0; i < data.length - 1; i++) {
                if (dist >= data[i][0] && dist <= data[i + 1][0]) {
                    const ratio = (dist - data[i][0]) / (data[i + 1][0] - data[i][0]);
                    const elev = data[i][1] + (data[i + 1][1] - data[i][1]) * ratio;
                    return elev;
                }
            }
            return null;
        }

        // Обработчики событий карты
        map.on('contextmenu', (e) => {
            if (mortarMarker) map.removeLayer(mortarMarker);
            mortarMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'mortar-icon', html: '<div style="background:red;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
            mortarMarker.bindPopup(translations[currentLang].mortarPopup).openPopup();
            mortarMarker.on('dragend', calculateFromMap);
            calculateFromMap();
        });

        map.on('click', (e) => {
            if (targetMarker) map.removeLayer(targetMarker);
            targetMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'target-icon', html: '<div style="background:blue;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
            targetMarker.bindPopup(translations[currentLang].targetPopup).openPopup();
            targetMarker.on('dragend', calculateFromMap);
            calculateFromMap();
        });

        function calculateFromMap() {
            if (!mortarMarker || !targetMarker) return;
            const mortarPos = mortarMarker.getLatLng();
            const targetPos = targetMarker.getLatLng();
            let dist, dx, dy;
            const layer = document.getElementById('layer').value;
            if (layer === 'udache') {
                dx = targetPos.lng - mortarPos.lng;
                dy = targetPos.lat - mortarPos.lat;
                dist = Math.sqrt(dx * dx + dy * dy);
            } else {
                dist = mortarPos.distanceTo(targetPos);
                dx = targetPos.lng - mortarPos.lng;
                dy = targetPos.lat - mortarPos.lat;
            }
            const azRad = Math.atan2(dx, dy);
            let azDeg = (azRad * 180 / Math.PI + 360) % 360;
            const azUaMils = (azDeg / 360) * 6400;
            const azRuMils = (azDeg / 360) * 6000;
            const mortarType = document.getElementById('mortar').value;
            let data, azMils;
            if (mortarType === 'ua') {
                data = uaMortarData;
                azMils = azUaMils.toFixed(0);
            } else if (mortarType === 'ru') {
                data = ruMortarData;
                azMils = azRuMils.toFixed(0);
            } else {
                data = gradMortarData;
                azMils = azRuMils.toFixed(0);
            }
            let elev = interpolate(data, dist);
            let elevText = elev !== null ? `${elev.toFixed(1)} mils` : translations[currentLang].outOfRange;
            const t = translations[currentLang];
            document.getElementById('result').innerHTML = `
                ${t.rangeText}${dist.toFixed(0)} м<br>
                ${t.azimuthText}${azDeg.toFixed(1)}° (${azMils} mils)<br>
                ${t.elevationText}${elevText}
            `;
        }

        function calculateManual() {
            const dist = parseFloat(document.getElementById('distance').value);
            if (isNaN(dist)) return;
            const mortarType = document.getElementById('mortar').value;
            let data;
            if (mortarType === 'ua') {
                data = uaMortarData;
            } else if (mortarType === 'ru') {
                data = ruMortarData;
            } else {
                data = gradMortarData;
            }
            let elev = interpolate(data, dist);
            let elevText = elev !== null ? `${elev.toFixed(1)} mils` : translations[currentLang].outOfRange;
            const t = translations[currentLang];
            document.getElementById('result').innerHTML = `${t.manualRange}${dist} м | ${t.elevationText}${elevText}`;
        }

        function clearMap() {
            if (mortarMarker) map.removeLayer(mortarMarker);
            if (targetMarker) map.removeLayer(targetMarker);
            mortarMarker = null;
            targetMarker = null;
            document.getElementById('result').innerHTML = '';
        }

        function toggleControls() {
            const controls = document.getElementById('controls');
            controls.classList.toggle('active');
        }

        function toggleDeviceOptions() {
            const options = document.getElementById('device-options');
            options.classList.toggle('active');
        }

        document.addEventListener('click', (e) => {
            const deviceBtn = document.getElementById('device-btn');
            const deviceOptions = document.getElementById('device-options');
            if (!deviceBtn.contains(e.target) && !deviceOptions.contains(e.target)) {
                deviceOptions.classList.remove('active');
            }
        });

        function toggleInfo() {
            const panel = document.getElementById('info-panel');
            panel.classList.toggle('active');
        }

        let deviceMode = 'pc';
        let activeMode = null;

        function setDevice(mode) {
            deviceMode = mode;
            document.getElementById('device-options').classList.remove('active');
            if (mode === 'mobile') {
                document.getElementById('mobile-buttons').classList.add('active');
                map.off('contextmenu');
                map.off('click');
                map.on('click', handleMobileClick);
            } else {
                document.getElementById('mobile-buttons').classList.remove('active');
                map.off('click');
                map.on('contextmenu', (e) => {
                    if (mortarMarker) map.removeLayer(mortarMarker);
                    mortarMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'mortar-icon', html: '<div style="background:red;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                    mortarMarker.bindPopup(translations[currentLang].mortarPopup).openPopup();
                    mortarMarker.on('dragend', calculateFromMap);
                    calculateFromMap();
                });
                map.on('click', (e) => {
                    if (targetMarker) map.removeLayer(targetMarker);
                    targetMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'target-icon', html: '<div style="background:blue;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                    targetMarker.bindPopup(translations[currentLang].targetPopup).openPopup();
                    targetMarker.on('dragend', calculateFromMap);
                    calculateFromMap();
                });
            }
        }

        function toggleMobileButtons() {
            const mobileButtons = document.getElementById('mobile-buttons');
            mobileButtons.classList.remove('active');
            activeMode = null;
        }

        function activateMode(mode) {
            activeMode = mode;
            if (mode === 'mortar') {
                document.getElementById('mortar-btn').classList.add('active');
                document.getElementById('target-btn').classList.remove('active');
            } else if (mode === 'target') {
                document.getElementById('target-btn').classList.add('active');
                document.getElementById('mortar-btn').classList.remove('active');
            }
        }

        function handleMobileClick(e) {
            const t = translations[currentLang];
            if (activeMode === 'mortar') {
                if (mortarMarker) map.removeLayer(mortarMarker);
                mortarMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'mortar-icon', html: '<div style="background:red;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                mortarMarker.bindPopup(t.mortarPopup).openPopup();
                mortarMarker.on('dragend', calculateFromMap);
                calculateFromMap();
                activeMode = null;
                document.getElementById('mortar-btn').classList.remove('active');
            } else if (activeMode === 'target') {
                if (targetMarker) map.removeLayer(targetMarker);
                targetMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'target-icon', html: '<div style="background:blue;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                targetMarker.bindPopup(t.targetPopup).openPopup();
                targetMarker.on('dragend', calculateFromMap);
                calculateFromMap();
                activeMode = null;
                document.getElementById('target-btn').classList.remove('active');
            }
        }

        map.fitBounds(udacheBounds);
        updateTexts();
        updateLayerOptions();
        updateMortarOptions();
        updateLanguageOptions();
        updateInfoPanel();
    </script>
</body>
</html>









