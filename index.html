<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор миномета с картой Удачное</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
            background: #1a202c;
            color: #e2e8f0;
        }
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        
        /* Плавающая кнопка меню справа */
        #main-menu-btn {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2f855a, #38a169);
            color: #e2e8f0;
            border: 3px solid #4a5568;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(47, 133, 90, 0.4);
            transition: all 0.3s ease;
            z-index: 1500;
        }
        #main-menu-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 25px rgba(47, 133, 90, 0.6);
            background: linear-gradient(135deg, #38a169, #48bb78);
        }
        #main-menu-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Центральное модальное окно */
        #main-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        #main-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Главное окно меню */
        #menu-container {
            width: 90%;
            max-width: 900px;
            height: 80%;
            max-height: 600px;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 2px solid #4a5568;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            overflow: hidden;
            animation: slideIn 0.4s ease;
        }

        /* Левая панель навигации */
        #menu-sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2f855a, #38a169);
            padding: 20px 0;
            border-right: 2px solid #4a5568;
        }

        .menu-nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            color: #e2e8f0;
        }
        .menu-nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #68d391;
        }
        .menu-nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #68d391;
            color: #68d391;
        }
        .menu-nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 18px;
        }

        /* Правая панель содержимого */
        #menu-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #1a202c;
        }

        /* Заголовки разделов */
        .menu-section {
            display: none;
        }
        .menu-section.active {
            display: block;
        }
        .menu-section h2 {
            color: #68d391;
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 10px;
        }

        /* Кнопка закрытия */
        #menu-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: #e53e3e;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2001;
        }
        #menu-close-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { 
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        /* Стили для форм в военной тематике */
        .military-form-group {
            margin-bottom: 20px;
        }
        .military-label {
            display: block;
            color: #68d391;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .military-select, .military-input {
            width: 100%;
            padding: 12px;
            background: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .military-select:focus, .military-input:focus {
            outline: none;
            border-color: #68d391;
            box-shadow: 0 0 10px rgba(104, 211, 145, 0.3);
        }
        .military-select option {
            background: #2d3748;
            color: #e2e8f0;
        }
        .military-btn {
            background: linear-gradient(135deg, #2f855a, #38a169);
            color: #e2e8f0;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        .military-btn:hover {
            background: linear-gradient(135deg, #38a169, #48bb78);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(47, 133, 90, 0.4);
        }
        .military-btn:active {
            transform: translateY(0);
        }
        #result-panel {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 2px solid #68d391;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-size: 14px;
            color: #e2e8f0;
            backdrop-filter: blur(10px);
        }
        #result-panel.active {
            display: block;
            animation: slideUp 0.4s ease;
        }
        #result-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #e53e3e;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        #result-panel .close-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }
        @keyframes slideUp {
            from { 
                transform: translateY(100px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* Быстрое меню для очистки карты */
        #quick-actions {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        .quick-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border: 2px solid #68d391;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .quick-btn:hover {
            background: linear-gradient(135deg, #4a5568, #68d391);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(104, 211, 145, 0.4);
        }
        #mobile-buttons {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 100px;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 2px solid #4a5568;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 200px;
        }
        #mobile-buttons.active {
            display: flex;
            animation: slideUp 0.4s ease;
        }
        #mobile-close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            background: #e53e3e;
            border: none;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        #mobile-close-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }
        /* Адаптивные стили */
        @media (max-width: 768px) {
            #main-menu-btn {
                right: 10px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #menu-container {
                width: 95%;
                height: 90%;
                flex-direction: column;
            }
            
            #menu-sidebar {
                width: 100%;
                height: 80px;
                padding: 10px 0;
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
            }
            
            .menu-nav-item {
                min-width: 120px;
                padding: 10px 15px;
                text-align: center;
                border-left: none;
                border-bottom: 4px solid transparent;
            }
            .menu-nav-item.active,
            .menu-nav-item:hover {
                border-bottom-color: #68d391;
                border-left-color: transparent;
            }
            
            #menu-content {
                padding: 20px;
                height: calc(100% - 80px);
            }
            
            #quick-actions {
                top: 10px;
                left: 10px;
            }
            .quick-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            #mobile-buttons {
                bottom: 10px;
                right: 10px;
                min-width: 180px;
            }
            
            #result-panel {
                width: calc(100% - 20px);
                left: 10px;
                bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            #menu-sidebar {
                height: 60px;
            }
            
            .menu-nav-item {
                min-width: 100px;
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .menu-nav-item i {
                font-size: 16px;
                margin-right: 8px;
            }
            
            #menu-content {
                padding: 15px;
            }
            
            .menu-section h2 {
                font-size: 20px;
            }
        }
        #info-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
        }
        #info-panel.active {
            display: block;
        }
        #info-panel h2 {
            margin-top: 0;
        }
        #info-panel ul {
            padding-left: 20px;
        }
        #info-panel button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        #info-panel button:hover {
            background-color: #555;
        }
        #credits {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #68d391;
            z-index: 1000;
            text-align: center;
            background: rgba(26, 32, 44, 0.8);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #4a5568;
        }
        #language-control {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        .close-btn:hover {
            color: #555;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Быстрые действия -->
    <div id="quick-actions">
        <button class="quick-btn" onclick="clearMap()" title="Очистить карту">
            <i class="fas fa-trash"></i>
        </button>
    </div>

    <!-- Главная кнопка меню -->
    <button id="main-menu-btn" onclick="toggleMainMenu()" title="Открыть меню">
        <i class="fas fa-cog"></i>
    </button>

    <!-- Главное модальное окно -->
    <div id="main-modal">
        <button id="menu-close-btn" onclick="toggleMainMenu()">&times;</button>
        <div id="menu-container">
            <!-- Левая панель навигации -->
            <div id="menu-sidebar">
                <div class="menu-nav-item active" onclick="showMenuSection('mortar-section')" data-section="mortar">
                    <i class="fas fa-crosshairs"></i>
                    <span>Тип миномета</span>
                </div>
                <div class="menu-nav-item" onclick="showMenuSection('language-section')" data-section="language">
                    <i class="fas fa-globe"></i>
                    <span>Язык</span>
                </div>
                <div class="menu-nav-item" onclick="showMenuSection('device-section')" data-section="device">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Устройство</span>
                </div>
                <div class="menu-nav-item" onclick="showMenuSection('map-section')" data-section="map">
                    <i class="fas fa-map"></i>
                    <span>Выбор карты</span>
                </div>
                <div class="menu-nav-item" onclick="showMenuSection('calc-section')" data-section="calc">
                    <i class="fas fa-calculator"></i>
                    <span>Расчеты</span>
                </div>
                <div class="menu-nav-item" onclick="showMenuSection('info-section')" data-section="info">
                    <i class="fas fa-info-circle"></i>
                    <span>Информация</span>
                </div>
            </div>
            
            <!-- Правая панель содержимого -->
            <div id="menu-content">
                <!-- Раздел типа миномета -->
                <div id="mortar-section" class="menu-section active">
                    <h2><i class="fas fa-crosshairs"></i> Тип оружия</h2>
                    <div class="military-form-group">
                        <label class="military-label" for="mortar">Выберите тип оружия:</label>
                        <select id="mortar" class="military-select">
                            <option value="ua">UA (US M821 HE 81mm)</option>
                            <option value="ru">RU (О-832Д 82mm)</option>
                            <option value="grad">BM-21 Grad (122mm)</option>
                        </select>
                    </div>
                </div>

                <!-- Раздел языка -->
                <div id="language-section" class="menu-section">
                    <h2><i class="fas fa-globe"></i> Язык интерфейса</h2>
                    <div class="military-form-group">
                        <label class="military-label" for="language">Выберите язык:</label>
                        <select id="language" class="military-select" onchange="changeLanguage()">
                            <option value="ru">Русский</option>
                            <option value="uk">Українська</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>

                <!-- Раздел устройства -->
                <div id="device-section" class="menu-section">
                    <h2><i class="fas fa-mobile-alt"></i> Выбор устройства</h2>
                    <div class="military-form-group">
                        <button class="military-btn" onclick="setDevice('pc')">
                            <i class="fas fa-desktop"></i> ПК
                        </button>
                        <button class="military-btn" onclick="setDevice('mobile')">
                            <i class="fas fa-mobile-alt"></i> Мобильное устройство
                        </button>
                    </div>
                </div>

                <!-- Раздел выбора карты -->
                <div id="map-section" class="menu-section">
                    <h2><i class="fas fa-map"></i> Выбор карты</h2>
                    <div class="military-form-group">
                        <label class="military-label" for="layer">Выберите карту:</label>
                        <select id="layer" class="military-select" onchange="changeLayer()">
                            <option value="udache">Удачное</option>
                            <option value="osm">Сергеевка</option> <!-- ЗАМЕНИТЕ PNG: sergeevka.png -->
                            <option value="satellite">Донецкий Аэропорт</option> <!-- ЗАМЕНИТЕ PNG: don_air.png -->
                        </select>
                    </div>
                </div>

                <!-- Раздел расчетов -->
                <div id="calc-section" class="menu-section">
                    <h2><i class="fas fa-calculator"></i> Ручные расчеты</h2>
                    <div class="military-form-group">
                        <label class="military-label" for="distance">Расстояние (м, опционально):</label>
                        <input type="number" id="distance" class="military-input" min="0" placeholder="например, 1350">
                    </div>
                    <div class="military-form-group">
                        <label class="military-label" for="h_mortar">Высота миномета (м):</label>
                        <input type="number" id="h_mortar" class="military-input" value="0" placeholder="например, 170">
                    </div>
                    <div class="military-form-group">
                        <label class="military-label" for="h_target">Высота цели (м):</label>
                        <input type="number" id="h_target" class="military-input" value="0" placeholder="например, 120">
                    </div>
                    <button class="military-btn" onclick="calculateManual()">
                        <i class="fas fa-calculator"></i> Рассчитать вручную
                    </button>
                </div>

                <!-- Раздел информации -->
                <div id="info-section" class="menu-section">
                    <h2><i class="fas fa-info-circle"></i> Информация</h2>
                    <div id="info-content">
                        <h3>Как использовать:</h3>
                        <ul>
                            <li>Выберите тип оружия в настройках.</li>
                            <li>На ПК: Правый клик - поставить миномет (красный маркер), левый клик - поставить цель (синий маркер).</li>
                            <li>На мобильном: Выберите режим (миномет или цель) и кликните на карту.</li>
                            <li>Перетаскивайте маркеры для корректировки.</li>
                            <li>Используйте ручной ввод расстояния и высот для расчета без карты.</li>
                            <li>Смените карту в выборе слоя.</li>
                        </ul>
                        <p>Расчеты основаны на таблицах для указанных боеприпасов.</p>
                        <p><strong>Автор:</strong> PRONEDROG</p>
                        <p><strong>Данные карт предоставлены:</strong> Conflict In Europe</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Панель результатов -->
    <div id="result-panel">
        <button class="close-btn" onclick="closeResult()">&times;</button>
        <div id="result"></div>
    </div>
    <!-- Мобильные кнопки -->
    <div id="mobile-buttons">
        <button class="close-btn" id="mobile-close-btn" onclick="toggleMobileButtons()">&times;</button>
        <button class="military-btn" id="mortar-btn" onclick="activateMode('mortar')">
            <i class="fas fa-crosshairs"></i> Поставить миномёт
        </button>
        <button class="military-btn" id="target-btn" onclick="activateMode('target')">
            <i class="fas fa-bullseye"></i> Поставить цель
        </button>
    </div>
    <div id="credits">
        Powered by PRONEDROG | За поддержкой Conflict In Europe
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Language data
        const translations = {
            ru: {
                title: 'Калькулятор миномета с картой Удачное',
                mortarLabel: 'Тип оружия:',
                mortarOptions: {
                    ua: 'UA (US M821 HE 81mm)',
                    ru: 'RU (О-832Д 82mm)',
                    grad: 'BM-21 Grad (122mm)'
                },
                distanceLabel: 'Ручное расстояние (м, опционально):',
                h_mortarLabel: 'Высота миномета (м):',
                h_targetLabel: 'Высота цели (м):',
                calculateManualBtn: 'Рассчитать вручную',
                layerLabel: 'Выбор карты:',
                layerOptions: {
                    udache: 'Удачное',
                    osm: 'Сергеевка',
                    satellite: 'Донецкий Аэропорт'
                },
                languageLabel: 'Язык:',
                languageOptions: {
                    ru: 'Русский',
                    uk: 'Українська',
                    en: 'English'
                },
                deviceBtnTitle: 'Выбор устройства',
                pcBtn: 'ПК',
                mobileBtn: 'Телефон',
                mortarBtn: 'Поставить миномёт',
                targetBtn: 'Поставить цель',
                mortarPopup: 'Миномет',
                targetPopup: 'Цель',
                infoTitle: 'Информация',
                infoText: `
                    <h3>Как использовать:</h3>
                    <ul>
                        <li>Выберите тип оружия в настройках.</li>
                        <li>На ПК: Правий клик - поставить миномет (красный маркер), левый клик - поставить цель (синий маркер).</li>
                        <li>На мобильном: Выберите режим (миномет или цель) и кликните на карту.</li>
                        <li>Перетаскивайте маркеры для корректировки.</li>
                        <li>Используйте ручной ввод расстояния и высот для расчета без карты.</li>
                        <li>Смените карту в выборе слоя.</li>
                    </ul>
                    <p>Расчеты основаны на таблицах для указанных боеприпасов.</p>
                    <p><strong>Автор:</strong> PRONEDROG</p>
                    <p><strong>Данные карт предоставлены:</strong> Conflict In Europe</p>
                `,
                closeBtn: 'Закрыть',
                clearMapTitle: 'Очистить карту',
                settingsTitle: 'Открыть настройки',
                infoBtnTitle: 'Информация',
                rangeText: 'Расстояние: ',
                adjustedRangeText: 'Скорректированное расстояние: ',
                azimuthText: 'Азимут: ',
                elevationText: 'Угол возвышения: ',
                outOfRange: 'Вне диапазона!',
                manualRange: 'Ручное расстояние: ',
                credits: 'Powered by PRONEDROG | За поддержкой Conflict In Europe'
            },
            uk: {
                title: 'Калькулятор міномета з картою Удачне',
                mortarLabel: 'Тип зброї:',
                mortarOptions: {
                    ua: 'UA (US M821 HE 81mm)',
                    ru: 'RU (О-832Д 82mm)',
                    grad: 'BM-21 Grad (122mm)'
                },
                distanceLabel: 'Ручна відстань (м, опціонально):',
                h_mortarLabel: 'Висота міномета (м):',
                h_targetLabel: 'Висота цілі (м):',
                calculateManualBtn: 'Розрахувати вручну',
                layerLabel: 'Вибір карти:',
                layerOptions: {
                    udache: 'Удачне',
                    osm: 'Сергеївка',
                    satellite: 'Донецький Аеропорт'
                },
                languageLabel: 'Мова:',
                languageOptions: {
                    ru: 'російська',
                    uk: 'Українська',
                    en: 'English'
                },
                deviceBtnTitle: 'Вибір пристрою',
                pcBtn: 'ПК',
                mobileBtn: 'Телефон',
                mortarBtn: 'Поставити міномет',
                targetBtn: 'Поставити ціль',
                mortarPopup: 'Міномет',
                targetPopup: 'Ціль',
                infoTitle: 'Інформація',
                infoText: `
                    <h3>Як использовать:</h3>
                    <ul>
                        <li>Виберіть тип зброї в налаштуваннях.</li>
                        <li>На ПК: Правий клік - поставити міномет (червоний маркер), лівий клік - поставити ціль (синій маркер).</li>
                        <li>На мобільному: Виберіть режим (міномет або ціль) і клікніть на карту.</li>
                        <li>Перетягуйте маркери для коригування.</li>
                        <li>Використовуйте ручний ввід відстані та висот для розрахунку без карти.</li>
                        <li>Змініть карту у виборі шару.</li>
                    </ul>
                    <p>Розрахунки базуються на таблицях для вказаних боєприпасів.</p>
                    <p><strong>Автор:</strong> PRONEDROG</p>
                    <p><strong>Дані карт надано:</strong> Conflict In Europe</p>
                `,
                closeBtn: 'Закрити',
                clearMapTitle: 'Очистити карту',
                settingsTitle: 'Відкрити налаштування',
                infoBtnTitle: 'Інформація',
                rangeText: 'Відстань: ',
                adjustedRangeText: 'Скоригована відстань: ',
                azimuthText: 'Азимут: ',
                elevationText: 'Кут піднесення: ',
                outOfRange: 'Поза діапазоном!',
                manualRange: 'Ручна відстань: ',
                credits: 'Powered by PRONEDROG | За підтримки Conflict In Europe'
            },
            en: {
                title: 'Mortar Calculator with Udachne Map',
                mortarLabel: 'Weapon Type:',
                mortarOptions: {
                    ua: 'UA (US M821 HE 81mm)',
                    ru: 'RU (О-832Д 82mm)',
                    grad: 'BM-21 Grad (122mm)'
                },
                distanceLabel: 'Manual Distance (m, optional):',
                h_mortarLabel: 'Mortar Height (m):',
                h_targetLabel: 'Target Height (m):',
                calculateManualBtn: 'Calculate Manually',
                layerLabel: 'Map Selection:',
                layerOptions: {
                    udache: 'Udachne',
                    osm: 'Sergeevka',
                    satellite: 'Donetsk Airport'
                },
                languageLabel: 'Language:',
                languageOptions: {
                    ru: 'Russian',
                    uk: 'Ukrainian',
                    en: 'English'
                },
                deviceBtnTitle: 'Device Selection',
                pcBtn: 'PC',
                mobileBtn: 'Mobile',
                mortarBtn: 'Place Mortar',
                targetBtn: 'Place Target',
                mortarPopup: 'Mortar',
                targetPopup: 'Target',
                infoTitle: 'Information',
                infoText: `
                    <h3>How to Use:</h3>
                    <ul>
                        <li>Select weapon type in settings.</li>
                        <li>On PC: Right-click to place mortar (red marker), left-click to place target (blue marker).</li>
                        <li>On mobile: Select mode (mortar or target) and click on map.</li>
                        <li>Drag markers to adjust.</li>
                        <li>Use manual distance and height inputs for calculation without map.</li>
                        <li>Change map in layer selection.</li>
                    </ul>
                    <p>Calculations based on tables for specified ammunition.</p>
                    <p><strong>Author:</strong> PRONEDROG</p>
                    <p><strong>Map Data Provided by:</strong> Conflict In Europe</p>
                `,
                closeBtn: 'Close',
                clearMapTitle: 'Clear Map',
                settingsTitle: 'Open Settings',
                infoBtnTitle: 'Information',
                rangeText: 'Distance: ',
                adjustedRangeText: 'Adjusted Distance: ',
                azimuthText: 'Azimuth: ',
                elevationText: 'Elevation Angle: ',
                outOfRange: 'Out of Range!',
                manualRange: 'Manual Distance: ',
                credits: 'Powered by PRONEDROG | Supported by Conflict In Europe'
            }
        };

        let currentLang = 'ru';

        function changeLanguage() {
            currentLang = document.getElementById('language').value;
            updateTexts();
            document.title = translations[currentLang].title;
            updateLayerOptions();
            updateMortarOptions();
            updateInfoPanel();
            document.getElementById('distance').placeholder = currentLang === 'ru' ? 'например, 1350' : (currentLang === 'uk' ? 'наприклад, 1350' : 'e.g., 1350');
            document.getElementById('h_mortar').placeholder = currentLang === 'ru' ? 'например, 170' : (currentLang === 'uk' ? 'наприклад, 170' : 'e.g., 170');
            document.getElementById('h_target').placeholder = currentLang === 'ru' ? 'например, 120' : (currentLang === 'uk' ? 'наприклад, 120' : 'e.g., 120');
        }

        function updateTexts() {
            const t = translations[currentLang];
            document.getElementById('mortar-label').textContent = t.mortarLabel;
            document.getElementById('distance-label').textContent = t.distanceLabel;
            document.getElementById('h_mortar-label').textContent = t.h_mortarLabel;
            document.getElementById('h_target-label').textContent = t.h_targetLabel;
            document.getElementById('calculate-manual-btn').textContent = t.calculateManualBtn;
            document.getElementById('layer-label').textContent = t.layerLabel;
            document.getElementById('language-label').textContent = t.languageLabel;
            document.getElementById('pc-btn').textContent = t.pcBtn;
            document.getElementById('mobile-btn').textContent = t.mobileBtn;
            document.getElementById('mortar-btn').textContent = t.mortarBtn;
            document.getElementById('target-btn').textContent = t.targetBtn;
            document.getElementById('device-btn').title = t.deviceBtnTitle;
            document.querySelector('.menu-btn:nth-child(2)').title = t.clearMapTitle;
            document.querySelector('.menu-btn:nth-child(1)').title = t.settingsTitle;
            document.querySelector('.menu-btn:nth-child(3)').title = t.infoBtnTitle;
            document.getElementById('credits').textContent = t.credits;
            if (mortarMarker) mortarMarker.bindPopup(t.mortarPopup);
            if (targetMarker) targetMarker.bindPopup(t.targetPopup);
        }

        function updateLayerOptions() {
            const t = translations[currentLang];
            const select = document.getElementById('layer');
            select.options[0].text = t.layerOptions.udache;
            select.options[1].text = t.layerOptions.osm;
            select.options[2].text = t.layerOptions.satellite;
        }

        function updateMortarOptions() {
            const t = translations[currentLang];
            const select = document.getElementById('mortar');
            select.options[0].text = t.mortarOptions.ua;
            select.options[1].text = t.mortarOptions.ru;
            select.options[2].text = t.mortarOptions.grad;
        }

        function updateInfoPanel() {
            const t = translations[currentLang];
            document.getElementById('info-title').textContent = t.infoTitle;
            document.getElementById('info-text').innerHTML = t.infoText;
            document.querySelector('#info-panel .close-btn').textContent = t.closeBtn;
        }

        function updateLanguageOptions() {
            const t = translations[currentLang];
            const select = document.getElementById('language');
            select.options[0].text = t.languageOptions.ru;
            select.options[1].text = t.languageOptions.uk;
            select.options[2].text = t.languageOptions.en;
        }

        function closeResult() {
            document.getElementById('result-panel').classList.remove('active');
        }

        // Инициализация карты с простой системой координат
        const mapWidth = 10240; // метры
        const mapHeight = 5120; // метры
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 2,
            zoom: -1,
            center: [mapHeight / 2, mapWidth / 2],
            maxBounds: [[0, 0], [mapHeight, mapWidth]],
            maxBoundsViscosity: 1.0
        });

        // Наложение карты Удачное
        const udacheBounds = [[0, 0], [mapHeight, mapWidth]];
        const udacheLayer = L.imageOverlay('IMG_20250917_162744_657.png', udacheBounds).addTo(map);

        // ========================================
        // ЗАМЕНА PNG КАРТИНОК ДЛЯ КАРТ:
        // ========================================
        // Для карты "Сергеевка" - замените файл ниже на ваш PNG файл:
        const sergeevkaLayer = L.imageOverlay('sergeevka.png', udacheBounds);
        
        // Для карты "Донецкий Аэропорт" - замените файл ниже на ваш PNG файл:
        const donAirLayer = L.imageOverlay('don_air.png', udacheBounds);
        // ========================================

        // Резервные онлайн слои (если PNG файлы недоступны)
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            noWrap: true
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
            noWrap: true
        });

        let currentLayer = udacheLayer;

        function changeLayer() {
            const layer = document.getElementById('layer').value;
            map.removeLayer(currentLayer);
            
            if (layer === 'udache') {
                currentLayer = udacheLayer;
                map.setView([mapHeight / 2, mapWidth / 2], -1);
                map.options.crs = L.CRS.Simple;
                map.setMaxBounds(udacheBounds);
                showNotification('Карта "Удачное" загружена');
            } else if (layer === 'osm') {
                // Попытка загрузить карту Сергеевка из PNG файла
                try {
                    currentLayer = sergeevkaLayer;
                    map.setView([mapHeight / 2, mapWidth / 2], -1);
                    map.options.crs = L.CRS.Simple;
                    map.setMaxBounds(udacheBounds);
                    showNotification('Карта "Сергеевка" загружена');
                } catch (error) {
                    // Если PNG недоступен, используем онлайн слой
                    map.options.crs = L.CRS.EPSG3857;
                    map.setMaxBounds(null);
                    map.setView([50.45, 30.52], 12);
                    currentLayer = osmLayer;
                    showNotification('Карта "Сергеевка" (онлайн режим)');
                }
            } else if (layer === 'satellite') {
                // Попытка загрузить карту Донецкий Аэропорт из PNG файла
                try {
                    currentLayer = donAirLayer;
                    map.setView([mapHeight / 2, mapWidth / 2], -1);
                    map.options.crs = L.CRS.Simple;
                    map.setMaxBounds(udacheBounds);
                    showNotification('Карта "Донецкий Аэропорт" загружена');
                } catch (error) {
                    // Если PNG недоступен, используем спутниковый слой
                    map.options.crs = L.CRS.EPSG3857;
                    map.setMaxBounds(null);
                    map.setView([50.45, 30.52], 12);
                    currentLayer = satelliteLayer;
                    showNotification('Карта "Донецкий Аэропорт" (спутник)');
                }
            }
            
            map.addLayer(currentLayer);
            
            // Очищаем маркеры при смене карты
            if (mortarMarker) {
                map.removeLayer(mortarMarker);
                mortarMarker = null;
            }
            if (targetMarker) {
                map.removeLayer(targetMarker);
                targetMarker = null;
            }
            document.getElementById('result-panel').classList.remove('active');
        }

        // Маркеры
        let mortarMarker = null;
        let targetMarker = null;

        // Данные минометов
        const uaMortarData = [
            [400, 1531], [500, 1514], [600, 1496], [700, 1478], [800, 1460], [900, 1442],
            [1000, 1424], [1100, 1405], [1200, 1385], [1300, 1366], [1400, 1346], [1500, 1326],
            [1600, 1305], [1700, 1283], [1800, 1261], [1900, 1238], [2000, 1214], [2100, 1188],
            [2200, 1162], [2300, 1134], [2400, 1104], [2500, 1070], [2600, 1034], [2700, 993],
            [2800, 942], [2900, 870]
        ];

        const ruMortarData = [
            [400, 1418], [500, 1398], [600, 1376], [700, 1355], [800, 1333], [900, 1311],
            [1000, 1288], [1100, 1264], [1200, 1240], [1300, 1215], [1400, 1189], [1500, 1161],
            [1600, 1133], [1700, 1102], [1800, 1069], [1900, 1034], [2000, 995], [2100, 950],
            [2200, 896], [2300, 820]
        ];

        const gradMortarData = [
            [3000, 140], [3200, 150], [3400, 159], [3600, 169], [3800, 179], [4000, 190],
            [4200, 200], [4400, 211], [4600, 221], [4800, 233], [5000, 244], [5200, 256],
            [5400, 268], [5600, 280], [5800, 293], [6000, 306], [6200, 320], [6400, 334],
            [6600, 349], [6800, 364], [7000, 380], [7200, 398], [7400, 416], [7600, 436],
            [7800, 458], [8000, 482], [8200, 509], [8400, 543], [8600, 587]
        ];

        function interpolate(data, dist) {
            if (dist < data[0][0] || dist > data[data.length - 1][0]) return null;
            for (let i = 0; i < data.length - 1; i++) {
                if (dist >= data[i][0] && dist <= data[i + 1][0]) {
                    const ratio = (dist - data[i][0]) / (data[i + 1][0] - data[i][0]);
                    const elev = data[i][1] + (data[i + 1][1] - data[i][1]) * ratio;
                    return elev;
                }
            }
            return null;
        }

        // Обработчики событий карты
        map.on('contextmenu', (e) => {
            if (mortarMarker) map.removeLayer(mortarMarker);
            mortarMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'mortar-icon', html: '<div style="background:red;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
            mortarMarker.bindPopup(translations[currentLang].mortarPopup).openPopup();
            mortarMarker.on('dragend', calculateFromMap);
            calculateFromMap();
        });

        map.on('click', (e) => {
            if (targetMarker) map.removeLayer(targetMarker);
            targetMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'target-icon', html: '<div style="background:blue;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
            targetMarker.bindPopup(translations[currentLang].targetPopup).openPopup();
            targetMarker.on('dragend', calculateFromMap);
            calculateFromMap();
        });

        function calculateFromMap() {
            if (!mortarMarker || !targetMarker) return;
            const mortarPos = mortarMarker.getLatLng();
            const targetPos = targetMarker.getLatLng();
            let dist, dx, dy;
            const layer = document.getElementById('layer').value;
            if (layer === 'udache') {
                dx = targetPos.lng - mortarPos.lng;
                dy = targetPos.lat - mortarPos.lat;
                dist = Math.sqrt(dx * dx + dy * dy);
            } else {
                dist = mortarPos.distanceTo(targetPos);
                dx = targetPos.lng - mortarPos.lng;
                dy = targetPos.lat - mortarPos.lat;
            }
            const azRad = Math.atan2(dx, dy);
            let azDeg = (azRad * 180 / Math.PI + 360) % 360;
            const azUaMils = (azDeg / 360) * 6400;
            const azRuMils = (azDeg / 360) * 6000;
            const mortarType = document.getElementById('mortar').value;
            let data, azMils;
            if (mortarType === 'ua') {
                data = uaMortarData;
                azMils = azUaMils.toFixed(0);
            } else if (mortarType === 'ru') {
                data = ruMortarData;
                azMils = azRuMils.toFixed(0);
            } else {
                data = gradMortarData;
                azMils = azRuMils.toFixed(0);
            }
            // Учет высоты
            const h_mortar = parseFloat(document.getElementById('h_mortar').value) || 0;
            const h_target = parseFloat(document.getElementById('h_target').value) || 0;
            const deltaH = h_target - h_mortar;
            const correction = Math.abs(deltaH) < 25 ? 0 : deltaH / 2;
            const adjustedDist = dist + (deltaH >= 0 ? correction : -correction);
            let elev = interpolate(data, adjustedDist);
            let elevText = elev !== null ? `${elev.toFixed(1)} mils` : translations[currentLang].outOfRange;
            const t = translations[currentLang];
            let resultText = `
                ${t.rangeText}${dist.toFixed(0)} м<br>
                ${t.azimuthText}${azDeg.toFixed(1)}° (${azMils} mils)<br>
                ${t.elevationText}${elevText}
            `;
            if (Math.abs(deltaH) >= 25) {
                resultText = `
                    ${t.rangeText}${dist.toFixed(0)} м<br>
                    ${t.adjustedRangeText}${adjustedDist.toFixed(0)} м<br>
                    ${t.azimuthText}${azDeg.toFixed(1)}° (${azMils} mils)<br>
                    ${t.elevationText}${elevText}
                `;
            }
            document.getElementById('result').innerHTML = resultText;
            document.getElementById('result-panel').classList.add('active');
        }

        function calculateManual() {
            const dist = parseFloat(document.getElementById('distance').value);
            if (isNaN(dist)) return;
            const mortarType = document.getElementById('mortar').value;
            let data;
            if (mortarType === 'ua') {
                data = uaMortarData;
            } else if (mortarType === 'ru') {
                data = ruMortarData;
            } else {
                data = gradMortarData;
            }
            // Учет высоты
            const h_mortar = parseFloat(document.getElementById('h_mortar').value) || 0;
            const h_target = parseFloat(document.getElementById('h_target').value) || 0;
            const deltaH = h_target - h_mortar;
            const correction = Math.abs(deltaH) < 25 ? 0 : deltaH / 2;
            const adjustedDist = dist + (deltaH >= 0 ? correction : -correction);
            let elev = interpolate(data, adjustedDist);
            let elevText = elev !== null ? `${elev.toFixed(1)} mils` : translations[currentLang].outOfRange;
            const t = translations[currentLang];
            let resultText = `${t.manualRange}${dist} м | ${t.elevationText}${elevText}`;
            if (Math.abs(deltaH) >= 25) {
                resultText = `
                    ${t.manualRange}${dist} м<br>
                    ${t.adjustedRangeText}${adjustedDist.toFixed(0)} м<br>
                    ${t.elevationText}${elevText}
                `;
            }
            document.getElementById('result').innerHTML = resultText;
            document.getElementById('result-panel').classList.add('active');
        }

        function clearMap() {
            if (mortarMarker) map.removeLayer(mortarMarker);
            if (targetMarker) map.removeLayer(targetMarker);
            mortarMarker = null;
            targetMarker = null;
            document.getElementById('result-panel').classList.remove('active');
        }

        // Функции главного меню
        function toggleMainMenu() {
            const modal = document.getElementById('main-modal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'hidden'; // Всегда скрываем overflow для карты
            }
        }

        function showMenuSection(sectionId) {
            // Скрываем все разделы
            const sections = document.querySelectorAll('.menu-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Убираем активный класс со всех навигационных элементов
            const navItems = document.querySelectorAll('.menu-nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // Показываем выбранный раздел
            document.getElementById(sectionId).classList.add('active');
            
            // Добавляем активный класс к соответствующему навигационному элементу
            const clickedNav = document.querySelector(`[onclick="showMenuSection('${sectionId}')"]`);
            if (clickedNav) clickedNav.classList.add('active');
        }

        // Закрытие модального окна при клике вне его
        document.getElementById('main-modal').addEventListener('click', (e) => {
            if (e.target.id === 'main-modal') {
                toggleMainMenu();
            }
        });

        let deviceMode = 'pc';
        let activeMode = null;

        function setDevice(mode) {
            deviceMode = mode;
            // Закрываем главное меню
            toggleMainMenu();
            
            if (mode === 'mobile') {
                document.getElementById('mobile-buttons').classList.add('active');
                map.off('contextmenu');
                map.off('click');
                map.on('click', handleMobileClick);
                
                // Показываем уведомление
                showNotification('Мобильный режим активирован. Выберите действие из панели справа.');
            } else {
                document.getElementById('mobile-buttons').classList.remove('active');
                map.off('click');
                map.on('contextmenu', (e) => {
                    if (mortarMarker) map.removeLayer(mortarMarker);
                    mortarMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'mortar-icon', html: '<div style="background:red;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                    mortarMarker.bindPopup(translations[currentLang].mortarPopup).openPopup();
                    mortarMarker.on('dragend', calculateFromMap);
                    calculateFromMap();
                });
                map.on('click', (e) => {
                    if (targetMarker) map.removeLayer(targetMarker);
                    targetMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'target-icon', html: '<div style="background:blue;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                    targetMarker.bindPopup(translations[currentLang].targetPopup).openPopup();
                    targetMarker.on('dragend', calculateFromMap);
                    calculateFromMap();
                });
                
                // Показываем уведомление
                showNotification('ПК режим активирован. ПКМ - миномет, ЛКМ - цель.');
            }
        }

        // Функция уведомлений
        function showNotification(text) {
            // Создаем элемент уведомления если его нет
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 50%;
                    transform: translateX(50%);
                    background: linear-gradient(135deg, #2f855a, #38a169);
                    color: #e2e8f0;
                    padding: 15px 25px;
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(47, 133, 90, 0.4);
                    z-index: 3000;
                    font-weight: bold;
                    opacity: 0;
                    transition: all 0.3s ease;
                    pointer-events: none;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = text;
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(50%) translateY(0)';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(50%) translateY(-20px)';
            }, 3000);
        }

        function toggleMobileButtons() {
            const mobileButtons = document.getElementById('mobile-buttons');
            mobileButtons.classList.remove('active');
            activeMode = null;
        }

        function activateMode(mode) {
            activeMode = mode;
            if (mode === 'mortar') {
                document.getElementById('mortar-btn').classList.add('active');
                document.getElementById('target-btn').classList.remove('active');
            } else if (mode === 'target') {
                document.getElementById('target-btn').classList.add('active');
                document.getElementById('mortar-btn').classList.remove('active');
            }
        }

        function handleMobileClick(e) {
            const t = translations[currentLang];
            if (activeMode === 'mortar') {
                if (mortarMarker) map.removeLayer(mortarMarker);
                mortarMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'mortar-icon', html: '<div style="background:red;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                mortarMarker.bindPopup(t.mortarPopup).openPopup();
                mortarMarker.on('dragend', calculateFromMap);
                calculateFromMap();
                activeMode = null;
                document.getElementById('mortar-btn').classList.remove('active');
            } else if (activeMode === 'target') {
                if (targetMarker) map.removeLayer(targetMarker);
                targetMarker = L.marker(e.latlng, { draggable: true, icon: L.divIcon({ className: 'target-icon', html: '<div style="background:blue;width:10px;height:10px;border-radius:50%;"></div>' }) }).addTo(map);
                targetMarker.bindPopup(t.targetPopup).openPopup();
                targetMarker.on('dragend', calculateFromMap);
                calculateFromMap();
                activeMode = null;
                document.getElementById('target-btn').classList.remove('active');
            }
        }

        map.fitBounds(udacheBounds);
        updateTexts();
        updateLayerOptions();
        updateMortarOptions();
        updateLanguageOptions();
        updateInfoPanel();
    </script>
</body>
</html>
